<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æŠ½çç³»çµ± - æ‰‹æ©Ÿç«¯</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f2f5; /* Slightly different background */
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        #status {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #333;
            font-weight: 500;
        }
        #join-section, #confirm-section, #waiting-section, #pairing-info {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
            width: 90%;
            max-width: 400px;
            box-sizing: border-box;
        }
        input[type="text"] {
            padding: 12px;
            font-size: 1em;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(70% - 12px); /* Adjust width considering button */
            box-sizing: border-box;
        }
        button {
            padding: 12px 20px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            color: white;
            font-weight: bold;
        }
        button:active {
             transform: scale(0.98);
        }
        #join-button {
            background-color: #007bff; /* Blue */
            width: 28%; /* Adjust width */
        }
        #join-button:hover {
            background-color: #0056b3;
        }
        #confirm-button {
            background-color: #28a745; /* Green */
            font-size: 1.2em; /* Make confirm button slightly larger */
            width: 100%; /* Full width */
            margin-top: 10px;
        }
        #confirm-button:hover {
            background-color: #218838;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #join-error, #confirm-error {
            color: red;
            margin-top: 15px;
            font-weight: bold;
            min-height: 1.2em; /* Reserve space for error message */
        }
        #display-name {
            color: #007bff;
            font-weight: bold;
        }
        #waiting-section p {
             color: #555;
             font-style: italic;
        }
        #pairing-info {
             font-size: 1.3em;
             font-weight: bold;
             color: #2c3e50;
             padding: 20px;
             background-color: #e9f7fd; /* Lighter blue background */
             border: 1px solid #bce0ee;
             line-height: 1.6;
        }
        #pairing-info span {
             color: #e67e22; /* Orange for partner name */
             font-weight: bolder;
        }

    </style>
</head>
<body>
    <div id="status">è«‹è¼¸å…¥æ‚¨çš„åå­—åŠ å…¥</div>

    <div id="join-section">
        <input type="text" id="name-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„åå­—" />
        <button id="join-button">åŠ å…¥</button>
        <div id="join-error"></div>
    </div>

    <div id="confirm-section" style="display: none;">
        <p><strong id="display-name"></strong>ï¼Œæ‚¨å·²æˆåŠŸåŠ å…¥ï¼</p>
        <button id="confirm-button">æŠ½ç‰Œ (ç¢ºèªåƒèˆ‡)</button>
        <div id="confirm-error"></div>
    </div>

    <div id="waiting-section" style="display: none;">
        <p>æŠ½ç‰Œå®Œæˆï¼è«‹ç­‰å¾…æ‰€æœ‰äººæŠ½å®Œå¾Œé–‹å§‹é…å°...</p>
    </div>

    <div id="pairing-info" style="display: none;">
        <!-- Pairing info will be inserted here -->
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            transports: ['websocket'] // Maintain forced WebSocket
        });

        // Get elements
        const statusDiv = document.getElementById('status');
        const joinSection = document.getElementById('join-section');
        const nameInput = document.getElementById('name-input');
        const joinButton = document.getElementById('join-button');
        const joinErrorDiv = document.getElementById('join-error');
        const confirmSection = document.getElementById('confirm-section');
        const displayName = document.getElementById('display-name');
        const confirmButton = document.getElementById('confirm-button');
        const confirmErrorDiv = document.getElementById('confirm-error');
        const waitingSection = document.getElementById('waiting-section');
        const pairingInfoDiv = document.getElementById('pairing-info');

        let joinedName = null;
        let isConfirmed = false;

        // --- Initial State ---
        function resetUI() {
            statusDiv.textContent = 'è«‹è¼¸å…¥æ‚¨çš„åå­—åŠ å…¥';
            joinSection.style.display = 'block';
            confirmSection.style.display = 'none';
            waitingSection.style.display = 'none';
            pairingInfoDiv.style.display = 'none';
            pairingInfoDiv.innerHTML = '';
            joinErrorDiv.textContent = '';
            confirmErrorDiv.textContent = '';
            nameInput.value = '';
            nameInput.disabled = false;
            joinButton.disabled = false;
            confirmButton.disabled = false;
            joinedName = null;
            isConfirmed = false;
        }

        resetUI(); // Initialize UI

        // --- Socket.IO Event Listeners ---
        socket.on('connect', () => {
            console.log('Connected to server', socket.id);
            resetUI();
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            statusDiv.textContent = 'èˆ‡ä¼ºæœå™¨æ–·ç·šï¼Œè«‹é‡æ–°æ•´ç†é é¢';
            joinButton.disabled = true;
            confirmButton.disabled = true;
        });

        socket.on('connect_error', (err) => {
            console.error('Connection error:', err);
            statusDiv.textContent = `é€£ç·šéŒ¯èª¤: ${err.message}`;
        });

        // Join success
        socket.on('joinSuccess', (data) => {
            console.log('Joined successfully as', data.name);
            joinedName = data.name;
            displayName.textContent = joinedName;
            statusDiv.textContent = 'åŠ å…¥æˆåŠŸï¼è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç¢ºèªåƒèˆ‡é…å°';
            joinSection.style.display = 'none';
            confirmSection.style.display = 'block';
            joinErrorDiv.textContent = '';
        });

        // Join failure
        socket.on('joinError', (message) => {
            console.error('Join error:', message);
            joinErrorDiv.textContent = message;
            nameInput.disabled = false;
            joinButton.disabled = false;
        });

        // Confirm success
        socket.on('confirmSuccess', () => {
            console.log('Participation confirmed');
            isConfirmed = true;
            statusDiv.textContent = 'ç¢ºèªæˆåŠŸï¼ç­‰å¾…é…å°é–‹å§‹...';
            confirmSection.style.display = 'none';
            waitingSection.style.display = 'block';
            confirmErrorDiv.textContent = '';
        });

        // Confirm failure
        socket.on('confirmError', (message) => {
            console.error('Confirm error:', message);
            confirmErrorDiv.textContent = message;
            confirmButton.disabled = false; // Allow retry
        });

        // Already confirmed
        socket.on('alreadyConfirmed', (message) => {
             console.log('Already confirmed');
             isConfirmed = true; // Sync state
             statusDiv.textContent = 'æ‚¨å·²ç¢ºèªéï¼Œç­‰å¾…é…å°é–‹å§‹...';
             confirmSection.style.display = 'none';
             waitingSection.style.display = 'block';
             confirmErrorDiv.textContent = ''; // Clear potential error message
        });

        // Received pairing result
        socket.on('yourPairing', (data) => {
            console.log('Received my pairing info:', data);
            waitingSection.style.display = 'none'; // Hide waiting message
            pairingInfoDiv.style.display = 'block'; // Show pairing result area
            if (data.partner) {
                pairingInfoDiv.innerHTML = `ğŸ‰ æ‚¨åœ¨ç¬¬ ${data.group} çµ„<br>èˆ‡ <span>${data.partner.name}</span> é…å°æˆåŠŸï¼`;
            } else {
                pairingInfoDiv.innerHTML = `ğŸ˜¢ æ‚¨åœ¨ç¬¬ ${data.group} çµ„ï¼Œæœ¬è¼ªè¼ªç©ºã€‚`;
            }
            statusDiv.textContent = 'é…å°çµæœå·²ç”¢ç”Ÿï¼';
        });

        // Received game reset command
        socket.on('gameReset', () => {
            console.log('Game has been reset by admin');
            alert('éŠæˆ²å·²é‡è¨­ï¼Œè«‹é‡æ–°åŠ å…¥ï¼'); // Alert user
            resetUI(); // Reset UI to initial state
        });

        // --- Button Events ---
        joinButton.addEventListener('click', () => {
            const name = nameInput.value;
            if (!name || name.trim() === '') {
                joinErrorDiv.textContent = 'è«‹è¼¸å…¥æ‚¨çš„åå­—ï¼';
                return;
            }
            console.log(`Attempting to join as ${name.trim()}`);
            joinErrorDiv.textContent = '';
            nameInput.disabled = true; // Prevent double clicks
            joinButton.disabled = true;
            socket.emit('joinGame', name.trim());
        });

        confirmButton.addEventListener('click', () => {
            if (!joinedName) {
                confirmErrorDiv.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚';
                return;
            }
            console.log('Confirming participation...');
            confirmErrorDiv.textContent = '';
            confirmButton.disabled = true; // Prevent double clicks
            socket.emit('confirmParticipation');
        });
    </script>
</body>
</html> 