<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>抽獎系統 - 手機端</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f2f5; /* Slightly different background */
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        #status {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #333;
            font-weight: 500;
        }
        #join-section, #confirm-section, #waiting-section, #pairing-info {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
            width: 90%;
            max-width: 400px;
            box-sizing: border-box;
        }
        input[type="text"] {
            padding: 12px;
            font-size: 1em;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(70% - 12px); /* Adjust width considering button */
            box-sizing: border-box;
        }
        button {
            padding: 12px 20px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            color: white;
            font-weight: bold;
        }
        button:active {
             transform: scale(0.98);
        }
        #join-button {
            background-color: #007bff; /* Blue */
            width: 28%; /* Adjust width */
        }
        #join-button:hover {
            background-color: #0056b3;
        }
        #confirm-button {
            background-color: #28a745; /* Green */
            font-size: 1.2em; /* Make confirm button slightly larger */
            width: 100%; /* Full width */
            margin-top: 10px;
        }
        #confirm-button:hover {
            background-color: #218838;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #join-error, #confirm-error {
            color: red;
            margin-top: 15px;
            font-weight: bold;
            min-height: 1.2em; /* Reserve space for error message */
        }
        #display-name {
            color: #007bff;
            font-weight: bold;
        }
        #waiting-section p {
             color: #555;
             font-style: italic;
        }
        #pairing-info {
             font-size: 1.3em;
             font-weight: bold;
             color: #2c3e50;
             padding: 20px;
             background-color: #e9f7fd; /* Lighter blue background */
             border: 1px solid #bce0ee;
             line-height: 1.6;
        }
        #pairing-info span {
             color: #e67e22; /* Orange for partner name */
             font-weight: bolder;
        }

    </style>
</head>
<body>
    <div id="status">請輸入您的名字加入</div>

    <div id="join-section">
        <input type="text" id="name-input" placeholder="請輸入您的名字" />
        <button id="join-button">加入</button>
        <div id="join-error"></div>
    </div>

    <div id="confirm-section" style="display: none;">
        <p><strong id="display-name"></strong>，您已成功加入！</p>
        <button id="confirm-button">抽牌 (確認參與)</button>
        <div id="confirm-error"></div>
    </div>

    <div id="waiting-section" style="display: none;">
        <p>抽牌完成！請等待所有人抽完後開始配對...</p>
    </div>

    <div id="pairing-info" style="display: none;">
        <!-- Pairing info will be inserted here -->
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            transports: ['websocket'] // Maintain forced WebSocket
        });

        // Get elements
        const statusDiv = document.getElementById('status');
        const joinSection = document.getElementById('join-section');
        const nameInput = document.getElementById('name-input');
        const joinButton = document.getElementById('join-button');
        const joinErrorDiv = document.getElementById('join-error');
        const confirmSection = document.getElementById('confirm-section');
        const displayName = document.getElementById('display-name');
        const confirmButton = document.getElementById('confirm-button');
        const confirmErrorDiv = document.getElementById('confirm-error');
        const waitingSection = document.getElementById('waiting-section');
        const pairingInfoDiv = document.getElementById('pairing-info');

        let joinedName = null;
        let isConfirmed = false;

        // --- Initial State ---
        function resetUI() {
            statusDiv.textContent = '請輸入您的名字加入';
            joinSection.style.display = 'block';
            confirmSection.style.display = 'none';
            waitingSection.style.display = 'none';
            pairingInfoDiv.style.display = 'none';
            pairingInfoDiv.innerHTML = '';
            joinErrorDiv.textContent = '';
            confirmErrorDiv.textContent = '';
            nameInput.value = '';
            nameInput.disabled = false;
            joinButton.disabled = false;
            confirmButton.disabled = false;
            joinedName = null;
            isConfirmed = false;
        }

        resetUI(); // Initialize UI

        // --- Socket.IO Event Listeners ---
        socket.on('connect', () => {
            console.log('Connected to server', socket.id);
            resetUI();
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            statusDiv.textContent = '與伺服器斷線，請重新整理頁面';
            joinButton.disabled = true;
            confirmButton.disabled = true;
        });

        socket.on('connect_error', (err) => {
            console.error('Connection error:', err);
            statusDiv.textContent = `連線錯誤: ${err.message}`;
        });

        // Join success
        socket.on('joinSuccess', (data) => {
            console.log('Joined successfully as', data.name);
            joinedName = data.name;
            displayName.textContent = joinedName;
            statusDiv.textContent = '加入成功！請點擊下方按鈕確認參與配對';
            joinSection.style.display = 'none';
            confirmSection.style.display = 'block';
            joinErrorDiv.textContent = '';
        });

        // Join failure
        socket.on('joinError', (message) => {
            console.error('Join error:', message);
            joinErrorDiv.textContent = message;
            nameInput.disabled = false;
            joinButton.disabled = false;
        });

        // Confirm success
        socket.on('confirmSuccess', () => {
            console.log('Participation confirmed');
            isConfirmed = true;
            statusDiv.textContent = '確認成功！等待配對開始...';
            confirmSection.style.display = 'none';
            waitingSection.style.display = 'block';
            confirmErrorDiv.textContent = '';
        });

        // Confirm failure
        socket.on('confirmError', (message) => {
            console.error('Confirm error:', message);
            confirmErrorDiv.textContent = message;
            confirmButton.disabled = false; // Allow retry
        });

        // Already confirmed
        socket.on('alreadyConfirmed', (message) => {
             console.log('Already confirmed');
             isConfirmed = true; // Sync state
             statusDiv.textContent = '您已確認過，等待配對開始...';
             confirmSection.style.display = 'none';
             waitingSection.style.display = 'block';
             confirmErrorDiv.textContent = ''; // Clear potential error message
        });

        // Received pairing result
        socket.on('yourPairing', (data) => {
            console.log('Received my pairing info:', data);
            waitingSection.style.display = 'none'; // Hide waiting message
            pairingInfoDiv.style.display = 'block'; // Show pairing result area
            if (data.partner) {
                pairingInfoDiv.innerHTML = `🎉 您在第 ${data.group} 組<br>與 <span>${data.partner.name}</span> 配對成功！`;
            } else {
                pairingInfoDiv.innerHTML = `😢 您在第 ${data.group} 組，本輪輪空。`;
            }
            statusDiv.textContent = '配對結果已產生！';
        });

        // Received game reset command
        socket.on('gameReset', () => {
            console.log('Game has been reset by admin');
            alert('遊戲已重設，請重新加入！'); // Alert user
            resetUI(); // Reset UI to initial state
        });

        // --- Button Events ---
        joinButton.addEventListener('click', () => {
            const name = nameInput.value;
            if (!name || name.trim() === '') {
                joinErrorDiv.textContent = '請輸入您的名字！';
                return;
            }
            console.log(`Attempting to join as ${name.trim()}`);
            joinErrorDiv.textContent = '';
            nameInput.disabled = true; // Prevent double clicks
            joinButton.disabled = true;
            socket.emit('joinGame', name.trim());
        });

        confirmButton.addEventListener('click', () => {
            if (!joinedName) {
                confirmErrorDiv.textContent = '發生錯誤，請重新整理頁面。';
                return;
            }
            console.log('Confirming participation...');
            confirmErrorDiv.textContent = '';
            confirmButton.disabled = true; // Prevent double clicks
            socket.emit('confirmParticipation');
        });
    </script>
</body>
</html> 