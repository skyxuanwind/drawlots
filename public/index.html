<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽獎配對系統 - 大螢幕</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>抽獎配對系統</h1>
    <div class="main-container">
        <div class="left-panel">
            <div id="info">
                <p>已加入人數: <span id="joined-count">--</span></p>
                <p>已確認人數 (抽卡): <span id="confirmed-count">--</span></p>
                <p>總連線數: <span id="total-connections">--</span></p>
            </div>
            <div id="qr-code">
                <p>請使用手機掃描 QR Code 加入</p>
                <img id="qr-code-img" src="" alt="QR Code">
            </div>
             <div id="controls-placeholder"></div>
             <!-- 配對結果顯示區域 -->
             <div id="results" style="margin-top: 20px; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                 <h2>配對結果</h2>
                 <ul id="results-list"></ul>
             </div>
             <button id="test-button" style="margin-top:10px; padding: 5px 10px; display: none;">模擬配對</button> <!-- 測試按鈕(可隱藏) -->

        </div>
        <div class="right-panel">
             <!-- 卡牌容器 -->
             <div id="card-container">
                 <!-- 卡牌將由 JS 動態生成 -->
             </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({ transports: ['websocket'] });

        // --- DOM Elements ---
        const joinedCountSpan = document.getElementById('joined-count');
        const confirmedCountSpan = document.getElementById('confirmed-count');
        const totalConnectionsSpan = document.getElementById('total-connections');
        const qrCodeImg = document.getElementById('qr-code-img');
        const cardContainer = document.getElementById('card-container');
        const resultsList = document.getElementById('results-list');
        const testButton = document.getElementById('test-button'); // 測試用

        let currentCardsState = []; // 儲存卡牌狀態
        let currentPairings = []; // 儲存配對結果

        // --- QR Code --- (保持不變)
        fetch('/qr')
            .then(response => response.json())
            .then(data => {
                if (data.qrCodeDataUrl) {
                    qrCodeImg.src = data.qrCodeDataUrl;
                } else {
                    console.error('Failed to load QR code');
                }
            })
            .catch(error => console.error('Error fetching QR code:', error));

        // --- Socket.IO Event Handlers ---
        socket.on('connect', () => {
            console.log('Connected to server as screen', socket.id);
            socket.emit('registerScreen'); // Register as screen
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            joinedCountSpan.textContent = '--';
            confirmedCountSpan.textContent = '--';
            totalConnectionsSpan.textContent = '--';
        });

        socket.on('connect_error', (err) => {
            console.error('Connection error:', err);
        });

        // 更新參與者狀態
        socket.on('participantState', (state) => {
            console.log('Received participant state:', state);
            joinedCountSpan.textContent = state.totalJoined || 0;
            confirmedCountSpan.textContent = state.totalConfirmed || 0;
            totalConnectionsSpan.textContent = state.totalConnections || 0;
        });

        // 更新卡牌視覺狀態 (重要)
        socket.on('updateCards', (cards) => {
            console.log('Received card state update:', cards);
            currentCardsState = cards;
            renderCards(currentCardsState);
        });

        // 單獨翻開某張卡並顯示名字 (重要)
        socket.on('revealCard', (data) => {
            console.log('Received reveal command for card:', data);
            const { cardId, name } = data;
            const cardElement = cardContainer.querySelector(`.card[data-card-id='${cardId}']`);
            if (cardElement) {
                const cardData = currentCardsState.find(c => c.id === cardId);
                if(cardData) cardData.revealed = true; // 更新本地狀態

                cardElement.classList.add('revealed');
                const nameElement = cardElement.querySelector('.card-name-part');
                const titleElement = cardElement.querySelector('.card-title-part');
                if (nameElement && titleElement) {
                     // 解析名字和職稱
                    const parts = name ? name.split(' ') : ['未知'];
                    nameElement.textContent = parts[0] || '??';
                    titleElement.textContent = parts.slice(1).join(' ') || '';
                }
            } else {
                 console.warn(`Card element not found for reveal: ${cardId}`);
            }
        });

        // 顯示配對結果
        socket.on('showPairingResults', (pairings) => {
            console.log('Received pairing results:', pairings);
            currentPairings = pairings;
            renderPairingResults(pairings);
        });

        // 配對錯誤
        socket.on('pairingError', (message) => {
            console.error('Pairing error:', message);
            alert(`配對失敗：${message}`);
        });

        // 遊戲重設
        socket.on('gameReset', () => {
            console.log('Game reset received.');
            currentCardsState = []; // 清空本地卡牌狀態
            currentPairings = [];
            renderCards([]); // 重新渲染空卡牌狀態 (會觸發初始化)
            resultsList.innerHTML = ''; // 清空配對結果
            // Participant counts will be updated via participantState event
        });

        // --- Rendering Functions ---
        function renderCards(cardsData) {
            if (!cardsData || cardsData.length === 0) {
                 console.log('Initializing empty cards...');
                 // 如果沒有卡牌數據 (例如重設後)，則重新初始化空的卡牌格子
                 cardsData = [];
                 for (let i = 1; i <= 51; i++) { // 假設總共 51 張
                     cardsData.push({ id: i, drawn: false, revealed: false });
                 }
                 currentCardsState = cardsData; // 更新本地狀態為初始狀態
            }

            cardContainer.innerHTML = ''; // Clear previous cards
            cardsData.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('card');
                cardElement.dataset.cardId = card.id;

                // 根據狀態添加 class
                if (card.drawn) cardElement.classList.add('drawn');
                if (card.revealed) cardElement.classList.add('revealed');

                // 解析名字 (如果已翻牌且名字存在)
                let namePart = '??';
                let titlePart = '';
                if (card.revealed && card.name) {
                     const parts = card.name.split(' ');
                     namePart = parts[0] || '??';
                     titlePart = parts.slice(1).join(' ') || '';
                }

                cardElement.innerHTML = `
                    <div class="card-inner">
                        <div class="card-face">
                             <span class="card-id-face">#${card.id}</span>
                             <span class="card-name-part">${namePart}</span>
                             <span class="card-title-part">${titlePart}</span>
                        </div>
                        <div class="card-back">
                             <span>${card.id}</span>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(cardElement);
            });
        }

        function renderPairingResults(pairings) {
            resultsList.innerHTML = '';
            if (!pairings || pairings.length === 0) {
                resultsList.innerHTML = '<li>尚無配對結果</li>';
                return;
            }
            pairings.forEach(pair => {
                const li = document.createElement('li');
                const member1 = pair.members[0] ? pair.members[0].name : 'N/A';
                const member2 = pair.members[1] ? pair.members[1].name : 'N/A';
                if (member2 === '輪空') {
                    li.innerHTML = `第 ${pair.group} 組: <span class="pair-member">${member1}</span> (本輪輪空)`;
                } else {
                     li.innerHTML = `第 ${pair.group} 組: <span class="pair-member">${member1}</span> &harr; <span class="pair-member">${member2}</span>`;
                }
                resultsList.appendChild(li);
            });
        }

        // --- Initial Render (optional, wait for server) ---
        // renderCards([]); // Initially render placeholders or wait for first updateCards

        // --- Test Button Logic (For Development) ---
        testButton.addEventListener('click', () => {
            console.log("Simulating pairing results for testing...");
            const testPairings = [
                { group: 1, members: [{ id: 'a', name: '測試者A' }, { id: 'b', name: '測試者B' }] },
                { group: 2, members: [{ id: 'c', name: '測試者C' }, { id: 'd', name: '測試者D 職稱' }] },
                { group: 3, members: [{ id: 'e', name: '測試者E' }, { id: null, name: '輪空' }] },
            ];
            renderPairingResults(testPairings);
            // Simulate revealing some cards
            const testCardReveal1 = { cardId: 1, name: '測試者A' };
            const testCardReveal2 = { cardId: 5, name: '測試者C' };
            socket.emit('revealCard', testCardReveal1); // Simulate receiving reveal
            socket.emit('revealCard', testCardReveal2);
        });

    </script>
</body>
</html> 